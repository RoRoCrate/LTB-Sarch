<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>データベース検索ツール</title>
<style>
/* --- root変数と基本スタイル (style.cssより) --- */
:root {
    --bg: #071121;
    --card: #0b1220;
    --muted: #9aa6b2;
    --accent: #60a5fa;
    --glass: rgba(255, 255, 255, 0.03);
    --radius: 12px;
    font-family: 'Noto Sans JP', sans-serif;
}

body {
    background-color: var(--bg);
    color: #fff;
    margin: 20px;
}

.btn {
    padding: 10px 20px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: bold;
}

/* --- 検索モーダルのスタイル --- */
.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: var(--card);
    padding: 24px;
    border-radius: var(--radius);
    width: 90%;
    max-width: 750px;
    max-height: 90vh;
    overflow-y: auto;
    border: 1px solid var(--accent);
    position: relative;
}

.close-btn {
    position: absolute;
    right: 15px; top: 15px;
    font-size: 28px;
    color: var(--muted);
    cursor: pointer;
}

/* --- 検索フォームのレイアウト --- */
.search-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

#searchInputsContainer {
    display: flex; 
    flex-wrap: wrap; 
    gap: 10px;
}

.search-input-group {
    width: calc(50% - 5px);
    box-sizing: border-box;
}

input[type="text"], select {
    width: 100%;
    padding: 10px;
    background: #1e203d;
    border: 1px solid #5560aa;
    color: #fff;
    border-radius: 6px;
    box-sizing: border-box;
}

label {
    display: block;
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 4px;
}

/* --- 検索結果のスタイル --- */
#searchResultWrapper {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid var(--accent);
    border-radius: 8px;
    background-color: rgba(0, 0, 0, 0.2);
}

.search-result-item {
    background-color: rgba(255, 255, 255, 0.03);
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid var(--accent);
    font-size: 0.9rem;
    line-height: 1.6;
}

.search-result-item strong {
    color: var(--accent);
}
</style>
</head>
<body>

<button id="searchButton" class="btn">データ検索を開く</button>

<div id="searchModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 style="margin-top:0;">データベース検索</h2>

        <div class="search-controls">
            <div>
                <label>検索対象データ</label>
                <select id="csvSelector"></select>
            </div>

            <div id="searchInputsContainer" class="dynamic-inputs"></div>
            
            <div>
                <label>キーワード検索 (全項目対象)</label>
                <input id="searchInput" type="text" placeholder="名称、効果、キーワードなどを入力..." />
            </div>
        </div>

        <h3 style="margin-top: 20px;">検索結果</h3>
        <div id="searchResultWrapper">
            <div id="searchResults">
                <p>キーワードを入力し、検索対象を選択してください。</p>
            </div>
        </div>
    </div>
</div>

<script>
/* --- 検索ロジック (script.jsより) --- */

const CSV_FILE_MAP = {
    'identity': { name: '人格', url: './identity.tsv' },
    'singularidentity': { name: '特異人格', url: './singularidentity.tsv' },
    'suppassive': { name: 'サポートパッシブ', url: './suppassive.tsv' },
    'mental': { name: '精神', url: './mental.tsv' },
    'ego': { name: 'E.G.O', url: './ego.tsv' },
    'status': { name: '状態異常', url: './status.tsv' },
    'item': { name: 'アイテム', url: './item.tsv' } 
};

// 各データ固有の検索フィールド定義
const SEARCH_FIELDS = {
    'identity': [
        { id: 'search_id_no', label: '番号', type: 'text', csvKey: '番号' },
        { id: 'search_id_name', label: '名称', type: 'text', csvKey: '名称' }
    ],
    'suppassive': [
        { id: 'search_sp_type', label: '通常/死亡', type: 'select', options: ['', '通常', '死亡'], csvKey: '種別' },
        { id: 'search_sp_resource', label: '資源', type: 'select', options: ['', '憤怒', '色欲','怠惰','暴食','憂鬱','傲慢','嫉妬','なし'], csvKey:'資源' },
        { id: 'search_sp_ownership', label: '保有/共鳴', type: 'select', options: ['', '保有', '共鳴','なし'], csvKey: '保有・共鳴' },
        { id: 'search_sp_price', label: '価格', type: 'text', csvKey: '価格' }
    ],
    'mental': [{ id: 'search_me_name', label: '名称', type: 'text', csvKey: '名称' }],
    'ego': [
        { id: 'search_ego_name', label: '名称', type: 'text', csvKey: '名称' },
        { id: 'search_ego_type', label: '種別', type: 'text', csvKey: '種別' }
    ],
    'status': [{ id: 'search_st_name', label: '名称', type: 'text', csvKey: '名称' }],
    'item': [{ id: 'search_it_name', label: '名称', type: 'text', csvKey: '名称' }]
};

const searchButton = document.getElementById('searchButton');
const searchModal = document.getElementById('searchModal');
const closeBtn = document.querySelector('.close-btn');
const csvSelector = document.getElementById('csvSelector');
const searchInput = document.getElementById('searchInput');
const searchInputsContainer = document.getElementById('searchInputsContainer');
const searchResults = document.getElementById('searchResults');

let currentSearchData = [];
let dataCache = {};

// 初期化：セレクターの生成
Object.keys(CSV_FILE_MAP).forEach(key => {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = CSV_FILE_MAP[key].name;
    csvSelector.appendChild(opt);
});

// TSVのパース
function parseTsv(text) {
    const lines = text.trim().split(/\r?\n/);
    const headers = lines[0].split('\t').map(h => h.trim());
    return lines.slice(1).map(line => {
        const values = line.split('\t');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim() : '');
        return obj;
    });
}

// データのロード
async function loadSearchData(key) {
    if (!dataCache[key]) {
        try {
            const res = await fetch(CSV_FILE_MAP[key].url);
            const text = await res.text();
            dataCache[key] = parseTsv(text);
        } catch (e) {
            console.error("データロード失敗:", e);
            return [];
        }
    }
    return dataCache[key];
}

// 固有検索項目の生成
function renderDynamicInputs(key) {
    searchInputsContainer.innerHTML = '';
    const fields = SEARCH_FIELDS[key] || [];
    fields.forEach(f => {
        const div = document.createElement('div');
        div.className = 'search-input-group';
        div.innerHTML = `<label>${f.label}</label>`;
        
        let input;
        if (f.type === 'select') {
            input = document.createElement('select');
            f.options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.textContent = o || 'すべて';
                input.appendChild(opt);
            });
        } else {
            input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `${f.label}で検索...`;
        }
        input.id = f.id;
        input.addEventListener('input', () => performSearch());
        div.appendChild(input);
        searchInputsContainer.appendChild(div);
    });
}

// 検索実行
function performSearch() {
    const query = searchInput.value.toLowerCase();
    const selectedKey = csvSelector.value;
    const fields = SEARCH_FIELDS[selectedKey] || [];

    const filtered = currentSearchData.filter(item => {
        // キーワード検索（全項目）
        const keywordMatch = Object.values(item).some(v => String(v).toLowerCase().includes(query));
        
        // 固有項目フィルタ
        const dynamicMatch = fields.every(f => {
            const el = document.getElementById(f.id);
            if (!el || !el.value) return true;
            return String(item[f.csvKey]).toLowerCase().includes(el.value.toLowerCase());
        });

        return keywordMatch && dynamicMatch;
    });

    displayResults(filtered);
}

function displayResults(data) {
    if (data.length === 0) {
        searchResults.innerHTML = '<p>該当するデータがありません。</p>';
        return;
    }
    searchResults.innerHTML = data.map(item => `
        <div class="search-result-item">
            ${Object.entries(item).map(([k, v]) => v ? `<div><strong>${k}:</strong> ${v}</div>` : '').join('')}
        </div>
    `).join('');
}

// イベント設定
searchButton.onclick = async () => {
    searchModal.style.display = 'flex';
    currentSearchData = await loadSearchData(csvSelector.value);
    renderDynamicInputs(csvSelector.value);
    performSearch();
};

closeBtn.onclick = () => searchModal.style.display = 'none';
csvSelector.onchange = async () => {
    currentSearchData = await loadSearchData(csvSelector.value);
    renderDynamicInputs(csvSelector.value);
    performSearch();
};
searchInput.oninput = () => performSearch();
window.onclick = (e) => { if(e.target == searchModal) searchModal.style.display = 'none'; };
</script>

</body>
</html>
