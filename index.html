<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>データベース検索システム</title>
<style>
:root {
    --bg: #071121;
    --card: #0b1220;
    --muted: #9aa6b2;
    --accent: #60a5fa;
    --radius: 12px;
    font-family: 'Noto Sans JP', sans-serif;
}

body {
    background-color: var(--bg);
    color: #fff;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

/* 検索コンテナの中央配置 */
.search-container {
    background: var(--card);
    padding: 30px;
    border-radius: var(--radius);
    width: 90%;
    max-width: 800px;
    border: 1px solid var(--accent);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
    margin: 20px;
}

.search-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

#searchInputsContainer {
    display: flex; 
    flex-wrap: wrap; 
    gap: 10px;
}

.search-input-group {
    width: calc(50% - 5px);
    box-sizing: border-box;
}

input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px;
    background: #1e203d;
    border: 1px solid #5560aa;
    color: #fff;
    border-radius: 6px;
    box-sizing: border-box;
}

label {
    display: block;
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 4px;
}

/* 検索結果エリア */
#searchResultWrapper {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 5px;
}

.search-result-item {
    background-color: rgba(255, 255, 255, 0.03);
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    border-left: 4px solid var(--accent);
    position: relative;
    font-size: 0.9rem;
}

.copy-btn {
    position: absolute;
    right: 10px;
    top: 10px;
    padding: 4px 8px;
    font-size: 0.75rem;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.copy-btn:hover { opacity: 0.8; }

@media (max-width: 600px) {
    .search-input-group { width: 100%; }
}
</style>
</head>
<body>

<div class="search-container">
    <h2 style="margin-top:0; text-align:center; color:var(--accent);">DATABASE SEARCH</h2>

    <div class="search-controls">
        <div>
            <label>検索対象データ</label>
            <select id="csvSelector"></select>
        </div>

        <div id="searchInputsContainer"></div>
        
        <div>
            <label>共通キーワード検索</label>
            <input id="searchInput" type="text" placeholder="全項目から検索..." />
        </div>
    </div>

    <div id="searchResultWrapper">
        <div id="searchResults"></div>
    </div>
</div>

<script>
const CSV_FILE_MAP = {
    'identity': { name: '人格', url: './identity.tsv' },
    'singularidentity': { name: '特異人格', url: './singularidentity.tsv' },
    'suppassive': { name: 'サポートパッシブ', url: './suppassive.tsv' },
    'mental': { name: '精神', url: './mental.tsv' },
    'ego': { name: 'E.G.O', url: './ego.tsv' },
    'status': { name: '状態異常', url: './status.tsv' },
    'item': { name: 'アイテム', url: './item.tsv' } 
};

const SEARCH_FIELDS = {
    'identity': [
        { id: 'f_no', label: '番号', type: 'text', csvKey: '番号' },
        { id: 'f_name', label: '名称', type: 'text', csvKey: '名称' }
    ],
    'singularidentity': [
        { id: 'f_no', label: '番号', type: 'text', csvKey: '番号' },
        { id: 'f_name', label: '名称', type: 'text', csvKey: '名称' }
    ],
    'suppassive': [
        { id: 'f_type', label: '通常/死亡', type: 'select', options: ['', '通常', '死亡'], csvKey: '種別' },
        { id: 'f_res', label: '資源', type: 'select', options: ['', '憤怒', '色欲','怠惰','暴食','憂鬱','傲慢','嫉妬','なし'], csvKey: '資源' },
        { id: 'f_own', label: '保有/共鳴', type: 'select', options: ['', '保有', '共鳴','なし'], csvKey: '保有・共鳴' },
        { id: 'f_price', label: '価格 (以下)', type: 'number', csvKey: '価格' }
    ],
    'mental': [
        { id: 'f_name', label: '名称', type: 'text', csvKey: '名称' },
        { id: 'f_price', label: '価格 (以下)', type: 'number', csvKey: '価格' }
    ],
    'ego': [
        { id: 'f_name', label: '名称', type: 'text', csvKey: '名称' },
        { id: 'f_rank', label: '危険度', type: 'select', options: ['', 'ZAYIN', 'TETH', 'HE', 'WAW', 'ALEPH'], csvKey: '危険度' },
        { id: 'f_price', label: '価格 (以下)', type: 'number', csvKey: '価格' }
    ],
    'status': [
        { id: 'f_name', label: '名称', type: 'text', csvKey: '名称' },
        { id: 'f_cat', label: '分類', type: 'select', options: ['', 'バフ', '中立バフ', 'デバフ', '蓄積要素', '弾丸', '特殊', '固有'], csvKey: '分類' }
    ],
    'item': [
        { id: 'f_name', label: '名称', type: 'text', csvKey: '名称' },
        { id: 'f_cat', label: '分類', type: 'select', options: ['', '特殊', '回復', '強化'], csvKey: '分類' }
    ]
};

const csvSelector = document.getElementById('csvSelector');
const searchInput = document.getElementById('searchInput');
const searchInputsContainer = document.getElementById('searchInputsContainer');
const searchResults = document.getElementById('searchResults');

let currentData = [];
let cache = {};

// 初期ロード
Object.keys(CSV_FILE_MAP).forEach(k => {
    const opt = document.createElement('option');
    opt.value = k; opt.textContent = CSV_FILE_MAP[k].name;
    csvSelector.appendChild(opt);
});

async function loadData() {
    const key = csvSelector.value;
    if (!cache[key]) {
        const res = await fetch(CSV_FILE_MAP[key].url);
        const text = await res.text();
        const lines = text.trim().split(/\r?\n/);
        const headers = lines[0].split('\t').map(h => h.trim());
        cache[key] = lines.slice(1).map(line => {
            const cols = line.split('\t');
            const obj = {};
            headers.forEach((h, i) => obj[h] = cols[i] ? cols[i].trim() : '');
            return obj;
        });
    }
    currentData = cache[key];
    renderFields(key);
    performSearch();
}

function renderFields(key) {
    searchInputsContainer.innerHTML = '';
    SEARCH_FIELDS[key].forEach(f => {
        const div = document.createElement('div');
        div.className = 'search-input-group';
        div.innerHTML = `<label>${f.label}</label>`;
        const input = document.createElement(f.type === 'select' ? 'select' : 'input');
        if (f.type !== 'select') input.type = f.type;
        if (f.type === 'select') {
            f.options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.textContent = o || 'すべて';
                input.appendChild(opt);
            });
        }
        input.id = f.id;
        input.addEventListener('input', performSearch);
        div.appendChild(input);
        searchInputsContainer.appendChild(div);
    });
}

function performSearch() {
    const query = searchInput.value.toLowerCase();
    const key = csvSelector.value;
    const fields = SEARCH_FIELDS[key];
    
    // 入力チェック（何も入力されていなければ空にする）
    const hasInput = query || fields.some(f => {
        const el = document.getElementById(f.id);
        return el && el.value !== '';
    });

    if (!hasInput) {
        searchResults.innerHTML = '';
        return;
    }

    const filtered = currentData.filter(item => {
        const keywordMatch = Object.values(item).some(v => String(v).toLowerCase().includes(query));
        const dynamicMatch = fields.every(f => {
            const el = document.getElementById(f.id);
            if (!el || el.value === '') return true;
            const val = item[f.csvKey];
            if (f.type === 'number') return Number(val) <= Number(el.value);
            return String(val).toLowerCase().includes(el.value.toLowerCase());
        });
        return keywordMatch && dynamicMatch;
    });

    renderResults(filtered);
}

function renderResults(data) {
    if (data.length === 0) {
        searchResults.innerHTML = '<p style="text-align:center; color:var(--muted);">一致するデータがありません</p>';
        return;
    }
    searchResults.innerHTML = data.map(item => {
        const textToCopy = Object.entries(item).map(([k,v]) => `${k}: ${v}`).join('\n');
        return `
            <div class="search-result-item">
                <button class="copy-btn" onclick="copyText(\`${textToCopy.replace(/`/g, '\\`')}\`)">コピー</button>
                ${Object.entries(item).map(([k, v]) => v ? `<div><strong>${k}:</strong> ${v}</div>` : '').join('')}
            </div>
        `;
    }).join('');
}

function copyText(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('クリップボードにコピーしました');
    });
}

csvSelector.onchange = loadData;
searchInput.oninput = performSearch;
window.onload = loadData;
</script>

</body>
</html>
